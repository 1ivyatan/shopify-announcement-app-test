<script>

    window.TSUFFIXRefreshCart = async function (shouldOpen = true, section = '') {
        document.dispatchEvent(new CustomEvent("apps:product-added-to-cart")); // yolo send into the void, stilleto theme

        if (section) {
            await window.TSUFFIXRefreshCartDrawersWithReq(section, shouldOpen);
            return Promise.resolve();
        }
        if ([2481, 3626, 3628, 3623, 3621, 3624, 3627, 3620, 3625].includes(window.LBTUThemeId)) { //horizon
            try {
                const { CartUpdateEvent } = await import('@theme/events');
                const cartDrawer = document.querySelector('cart-drawer-component');
                const response = await fetch('/cart.js');
                const cart = await response.json();

                const event = new CartUpdateEvent(cart, 'manual-trigger', {
                    itemCount: cart.item_count,
                    source: 'fad-refresh',
                    sections: {}
                });
                document.dispatchEvent(event);

                if (shouldOpen) {
                    cartDrawer.open();
                }

                return Promise.resolve();
            } catch (error) {
                console.error('Error refreshing cart (horizon):', error);
                return Promise.reject(error);
            }
        } else { // dawn etc
            var drawerUrl = '?section_id=cart-drawer';
            try {
                const response = await fetch(drawerUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                const responseText = await response.text();
                await window.TSUFFIXRefreshCartDrawersWithReq(responseText, shouldOpen);
                return Promise.resolve();
            } catch (error) {
                return Promise.reject(error);
            }
        }

    };

    window.TSUFFIXRefreshHeader = async function () {
        try {
            const response = await fetch(`/?section_id=header`);
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
            }
            const responseText = await response.text();

            const parser = new DOMParser();
            const html = parser.parseFromString(responseText, 'text/html');

            const newCartIcon = html.querySelector('#cart-icon-bubble');
            if (!newCartIcon) {
                throw new Error('Could not find cart icon element in response');
            }

            const currentCartIcon = document.querySelector('#cart-icon-bubble');
            if (currentCartIcon) {
                currentCartIcon.innerHTML = newCartIcon.innerHTML;

                if (newCartIcon.hasAttribute('class')) {
                    currentCartIcon.setAttribute('class', newCartIcon.getAttribute('class'));
                }

                Array.from(newCartIcon.attributes).forEach((attr) => {
                    if (attr.name !== 'id') {
                        currentCartIcon.setAttribute(attr.name, attr.value);
                    }
                });
            }
            return Promise.resolve();
        } catch (error) {
            return Promise.reject(error);
        }
    };

    window.TSUFFIXRefreshCartDrawersWithReq = async function (responseText, shouldOpen) {
        let drawerSelector = 'cart-drawer';
        let extraDrawerSelector = '';
        if (window.Shopify.shop === 'tbxwjk-gh.myshopify.com') {
            drawerSelector = '.cart-side-drawer .cart-drawer-content-body';
            extraDrawerSelector = '.cart-side-drawer .side-drawer-panel .cart-drawer-content-footer';
        }
        const parser = new DOMParser();
        const html = parser.parseFromString(responseText, 'text/html');

        const newCartDrawer = html.querySelector(drawerSelector);
        const newExtraDrawer = extraDrawerSelector != "" ? html.querySelector(extraDrawerSelector) : null;
        if (!newCartDrawer) {
            throw new Error('Could not find cart-drawer element in response');
        }

        const currentCartDrawer = document.querySelector(drawerSelector);
        const currentExtraDrawer = extraDrawerSelector ? document.querySelector(extraDrawerSelector) : null;
        if (currentCartDrawer) {
            currentCartDrawer.innerHTML = newCartDrawer.innerHTML;
            if (newCartDrawer.hasAttribute('class')) {
                currentCartDrawer.setAttribute('class', newCartDrawer.getAttribute('class'));
            }
            if (newExtraDrawer) {
                currentExtraDrawer.innerHTML = newExtraDrawer.innerHTML;
                if (newExtraDrawer.hasAttribute('class')) {
                    currentExtraDrawer.setAttribute('class', newExtraDrawer.getAttribute('class'));
                }
            }
            if (shouldOpen) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (typeof currentCartDrawer.open === 'function') {
                            currentCartDrawer.open();
                        }
                        resolve();
                    }, 100);
                });
            }
        }
        return Promise.resolve();
    };

    window.TSUFFIXRefreshCartFully = async (shouldOpen) => {
        //if on /cart refresh window    
        if (window.location.pathname === '/cart') {
            location.reload();
            return Promise.resolve();
        }
        await window.TSUFFIXRefreshCart(shouldOpen);
        window.TSUFFIXRefreshHeader();
        if (typeof window.SLIDECART_UPDATE === 'function') window.SLIDECART_UPDATE(); // amp cart

        if (window.TSUFFIXCustomCartRefresh) {
            window.TSUFFIXCustomCartRefresh();
        }
        return Promise.resolve();
    }
</script>